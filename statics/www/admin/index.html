<!DOCTYPE html>

<meta charset="UTF-8">

<style>
	#list > div {
		cursor: pointer;
	}
	#list > div:hover {
		background-color: silver;
	}
	#list > div.selected {
		font-weight: bold;
	}
</style>

<h1>Admin</h1>

<div id="list" style="float: left; width: 200px;">
	<button id="button_create">Crear post</button>
</div>

<div id="editor" style="margin-left: 220px; display: none;">
	Título:<br>
	<input id="editor_title" style="width: 100%;">
	<br>
	Cuerpo:<br>
	<textarea id="editor_body" style="width: 100%; height: 400px;"></textarea>
	<br>
	<div style="color: gray; margin: 8px 0; padding: 8px; background-color: papayawhip;">
		PostId: <span id="editor_id" style="font-family: monospace;"></span><br>
		Created: <span id="editor_created" style="font-family: monospace;"></span><br>
		Modified: <span id="editor_modified" style="font-family: monospace;"></span><br>
	</div>
	<button id="button_save">Guardar</button>
	<button id="button_delete">Borrar</button>
</div>

<script>

	let list = document.getElementById('list');

	let itemSelected = null;
	function AddPost(post) {
		let item = document.createElement('div');
		item.addEventListener('click', function () {
			if (itemSelected != null) {
				itemSelected.classList.remove('selected');
			}
			itemSelected = item;
			itemSelected.classList.add('selected');
			EditPost(post);
		}, true);
		item.textContent = post.title;
		list.appendChild(item);
		return item;
	}

	let lastPost = null;
	function EditPost(post) {
		if (lastPost != null) {
			// todo: save post? or warn user?
		}
		lastPost = post;
		document.getElementById('editor').style.display = '';
		document.getElementById('editor_id').innerText = post.id;
		document.getElementById('editor_created').innerText = post.creation_time;
		document.getElementById('editor_modified').innerText = post.modification_time;
		document.getElementById('editor_title').value = post.title;
		document.getElementById('editor_body').value = post.body;
	}

	function SavePost(post) {
		fetch('/v0/posts/'+encodeURIComponent(post.id), {
			method: 'PATCH',
			body: JSON.stringify(post),
		})
						.then(resp => resp.json())
						.then(newPost => {
							Object.assign(lastPost, newPost);
							EditPost(lastPost);
						})
	}

	function DeletePost(post) {
		fetch('/v0/posts/'+encodeURIComponent(post.id), {
			method: 'DELETE',
		})
						.then(resp => {
							document.getElementById('editor').style.display = 'none';
							itemSelected.style.display = 'none';
							itemSelected = null;
						})
	}

	fetch('/v0/posts')
					.then(resp => resp.json())
					.then(posts => {
							posts.forEach(AddPost)
					})

	document.getElementById('button_create').addEventListener('click', function() {
		let post = {"title":"Nuevo post", "body":"Escribe algo asombroso"};
		fetch('/v0/posts', {method: 'POST', body: JSON.stringify(post)})
						.then(resp => resp.json())
						.then(post => {
								AddPost(post);
								//EditPost(post);
						})
	}, true);

	document.getElementById('button_save').addEventListener('click', function() {
		SavePost({
			id: lastPost.id,
			title: document.getElementById('editor_title').value,
			body: document.getElementById('editor_body').value,
		})
	}, true);

	document.getElementById('button_delete').addEventListener('click', function(e) {
		if (!confirm('¿Estás seguro de que lo quieres borrar?')) {
			return;
		}
		DeletePost(lastPost);
	}, true);


</script>